<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise RAG Visualizer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- DESIGN SYSTEM (MNC Standard) --- */
        :root {
            /* Palette: Slate & Indigo */
            --primary: #4f46e5;       /* Indigo 600 */
            --primary-hover: #4338ca; /* Indigo 700 */
            --bg-body: #f8fafc;       /* Slate 50 */
            --bg-card: #ffffff;
            --text-main: #0f172a;     /* Slate 900 */
            --text-muted: #64748b;    /* Slate 500 */
            --border: #e2e8f0;        /* Slate 200 */
            --success: #10b981;       /* Emerald 500 */
            --accent: #f59e0b;        /* Amber 500 */
            
            /* Spacing & Radius */
            --radius: 12px;
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* --- LAYOUT --- */
        .container {
            max-width: 850px;
            margin: 0 auto;
        }

        /* --- HEADER --- */
        header {
            text-align: center;
            margin-bottom: 50px;
            position: relative;
        }
        .badge {
            background: #e0e7ff;
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        h1 { margin: 15px 0 10px; font-size: 2.25rem; letter-spacing: -0.025em; color: var(--text-main); }
        p.subtitle { color: var(--text-muted); max-width: 500px; margin: 0 auto; }

        /* --- CARDS (Steps) --- */
        .step-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-sm);
            opacity: 0.6;
            filter: grayscale(1);
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .step-card.active {
            opacity: 1;
            filter: grayscale(0);
            pointer-events: all;
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Step Number Indicator */
        .step-indicator {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 32px;
            height: 32px;
            background: var(--bg-body);
            color: var(--text-muted);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            transition: 0.3s;
        }
        .step-card.active .step-indicator {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .step-content { margin-left: 50px; }
        h2 { margin-top: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 10px; }
        .description { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px; }

        /* --- INPUTS & CONTROLS --- */
        label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-main); margin-bottom: 6px; }
        
        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fdfdfd;
        }
        input:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .controls-row { display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .control-item { flex: 1; min-width: 150px; }

        /* --- BUTTONS --- */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { background-color: var(--text-muted); cursor: not-allowed; opacity: 0.7; }
        
        .btn-secondary { background-color: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background-color: var(--bg-body); color: var(--primary); border-color: var(--primary); }

        /* --- VISUALIZATIONS (Grids) --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .data-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-size: 0.85rem;
            transition: 0.2s;
            position: relative;
        }
        .data-card:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); }
        
        .data-card strong { display: block; color: var(--primary); margin-bottom: 6px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Vector Visualization */
        .vector-array {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            background: #f1f5f9;
            padding: 8px;
            border-radius: 6px;
            word-break: break-all;
            margin-top: 8px;
        }

        /* Retrieval Score Bar */
        .score-bar-bg {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .score-bar-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 1s ease-out;
        }

        /* --- CODE & LLM --- */
        .terminal {
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            position: relative;
            overflow-x: auto;
            border: 1px solid #334155;
        }
        .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .tag-sys { background: #475569; color: white; }
        .tag-ctx { background: #4f46e5; color: white; }
        .tag-usr { background: #10b981; color: white; }

        .llm-box {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-left: 4px solid #22c55e;
            padding: 20px;
            border-radius: 8px;
            color: #14532d;
            font-size: 1rem;
            margin-top: 20px;
            min-height: 80px;
        }

        /* --- UTILS --- */
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Spinner */
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-left: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="container">
    <header>
        <span class="badge">Architecture V2.0</span>
        <h1>Enterprise RAG Visualizer</h1>
        <p class="subtitle">An interactive, bug-free demonstration of Retrieval-Augmented Generation workflows used in modern AI systems.</p>
        <button class="btn btn-secondary" onclick="resetApp()" style="margin-top: 20px; font-size: 0.8rem;">‚Ü∫ Reset System</button>
    </header>

    <!-- STEP 1: Ingestion -->
    <div id="step1" class="step-card active">
        <div class="step-indicator">1</div>
        <div class="step-content">
            <h2>Data Ingestion & Chunking</h2>
            <p class="description">Large documents must be split into smaller "chunks" to fit within the AI's context window. Overlap ensures context isn't lost at the split points.</p>
            
            <label>Knowledge Base (Source Text)</label>
            <textarea id="sourceText" rows="4" placeholder="Enter your text here...">RAG (Retrieval-Augmented Generation) is a technique that enhances Large Language Models by fetching relevant data from external sources before generating an answer. Instead of relying solely on training data, RAG splits documents into chunks, turns them into vectors, and retrieves the most similar chunks to the user's query. This process reduces hallucinations and ensures the model has up-to-date information.</textarea>
            
            <div class="controls-row">
                <div class="control-item">
                    <label>Chunk Size (Chars)</label>
                    <input type="number" id="chunkSize" value="100" min="20">
                </div>
                <div class="control-item">
                    <label>Overlap (Chars)</label>
                    <input type="number" id="chunkOverlap" value="20" min="0">
                </div>
                <div class="control-item" style="display: flex; align-items: flex-end;">
                    <button class="btn" onclick="runChunking()">
                        <span id="btnText1">Process Chunks</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- STEP 2: Visualization -->
    <div id="step2" class="step-card">
        <div class="step-indicator">2</div>
        <div class="step-content">
            <h2>Chunk Inspection</h2>
            <p class="description">Review how the data has been segmented. Each card represents a discrete unit of information.</p>
            <div id="chunksOutput" class="grid-container"></div>
            <div style="margin-top: 25px;">
                <button class="btn" onclick="runEmbeddings(this)">Generate Embeddings</button>
            </div>
        </div>
    </div>

    <!-- STEP 3: Vectorization -->
    <div id="step3" class="step-card">
        <div class="step-indicator">3</div>
        <div class="step-content">
            <h2>Vector Store (Embeddings)</h2>
            <p class="description">Text is converted into high-dimensional vectors (arrays of numbers). In a real system, these represent semantic meaning.</p>
            <div id="vectorsOutput" class="grid-container"></div>
            <div style="margin-top: 25px;">
                <button class="btn" onclick="saveVectors(this)">Index & Save to Database</button>
            </div>
        </div>
    </div>

    <!-- STEP 4: Query -->
    <div id="step4" class="step-card">
        <div class="step-indicator">4</div>
        <div class="step-content">
            <h2>User Query</h2>
            <p class="description">The system is ready. Enter a question to retrieve relevant context.</p>
            <div class="control-item">
                <input type="text" id="userQuery" placeholder="e.g. How does RAG prevent hallucinations?">
            </div>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="runRetrieval(this)">üîç Retrieve Context</button>
            </div>
        </div>
    </div>

    <!-- STEP 5: Retrieval -->
    <div id="step5" class="step-card">
        <div class="step-indicator">5</div>
        <div class="step-content">
            <h2>Semantic Retrieval</h2>
            <p class="description">The system calculates Cosine Similarity between your query vector and the database vectors.</p>
            
            <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <label style="margin:0;">Top K Results:</label>
                <input type="range" id="topK" min="1" max="5" value="2" oninput="updateTopKDisplay()">
                <strong id="topKVal" style="color:var(--primary)">2</strong>
            </div>

            <div id="retrievalOutput" class="grid-container"></div>
            
            <div style="margin-top: 25px;">
                <button class="btn" onclick="buildPrompt()">Construct Prompt</button>
            </div>
        </div>
    </div>

    <!-- STEP 6: Prompt Engineering -->
    <div id="step6" class="step-card">
        <div class="step-indicator">6</div>
        <div class="step-content">
            <h2>Contextual Prompting</h2>
            <p class="description">We inject the retrieved data into the system prompt to ground the LLM's response.</p>
            <div id="promptOutput" class="terminal"></div>
            <div style="margin-top: 25px;">
                <button class="btn" onclick="runLLM(this)">ü§ñ Generate Answer</button>
            </div>
        </div>
    </div>

    <!-- STEP 7: Generation -->
    <div id="step7" class="step-card">
        <div class="step-indicator">7</div>
        <div class="step-content">
            <h2>Final Output</h2>
            <p class="description">The LLM generates a response based <strong>only</strong> on the provided context.</p>
            <div id="llmOutput" class="llm-box hidden"></div>
        </div>
    </div>

</div>

<script>
    /* --- SYSTEM STATE --- */
    const state = {
        chunks: [],
        embeddings: [],
        queryEmbedding: [],
        searchResults: []
    };

    /* --- UTILITIES --- */
    const get = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    function activateStep(stepId) {
        const el = get(stepId);
        el.classList.add('active');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function resetApp() {
        if(confirm("Reset the entire visualization?")) {
            location.reload();
        }
    }

    /* --- STEP 1: CHUNKING --- */
    function runChunking() {
        const text = get('sourceText').value.trim();
        const size = parseInt(get('chunkSize').value);
        const overlap = parseInt(get('chunkOverlap').value);

        // Validation
        if (!text) return alert("Please enter source text.");
        if (size < 20) return alert("Chunk size must be at least 20 characters.");
        if (overlap >= size) return alert("Overlap must be smaller than chunk size.");

        state.chunks = [];
        let i = 0;
        
        while (i < text.length) {
            let chunk = text.slice(i, i + size);
            state.chunks.push(chunk);
            if (chunk.length < size) break; 
            i += (size - overlap);
        }

        renderChunks();
        activateStep('step2');
    }

    function renderChunks() {
        const container = get('chunksOutput');
        container.innerHTML = '';
        state.chunks.forEach((chunk, idx) => {
            const div = document.createElement('div');
            div.className = 'data-card fade-in';
            div.innerHTML = `<strong>Chunk ID: ${idx + 1}</strong><div>${chunk}</div>`;
            container.appendChild(div);
        });
    }

    /* --- STEP 3: EMBEDDINGS --- */
    // Simulation: Deterministic pseudo-random vectors
    function createPseudoVector(text) {
        const dim = 8; // vector dimensions
        let hash = 0;
        for (let i = 0; i < text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
        
        const vec = [];
        for (let i = 0; i < dim; i++) {
            const val = (Math.sin(hash + i) * 0.5) + 0.5; // normalize 0-1
            vec.push(val.toFixed(4));
        }
        return vec;
    }

    async function runEmbeddings(btn) {
        btn.disabled = true;
        btn.innerHTML = `Generating... <span class="spinner"></span>`;
        
        await sleep(1000); // Simulate API latency

        const container = get('vectorsOutput');
        container.innerHTML = '';
        state.embeddings = state.chunks.map((text, idx) => {
            const vec = createPseudoVector(text);
            
            // UI Render
            const div = document.createElement('div');
            div.className = 'data-card fade-in';
            div.innerHTML = `
                <strong>Vector ID: ${idx + 1}</strong>
                <div class="vector-array">[${vec.join(', ')}]</div>
            `;
            container.appendChild(div);

            return { id: idx, text, vector: vec };
        });

        btn.innerHTML = `Embeddings Created`;
        activateStep('step3');
    }

    async function saveVectors(btn) {
        btn.innerHTML = `Indexing... <span class="spinner"></span>`;
        await sleep(600);
        // LocalStorage logic
        localStorage.setItem('enterprise_rag_db', JSON.stringify(state.embeddings));
        btn.innerHTML = `Stored in Vector DB`;
        btn.classList.replace('btn', 'btn-secondary'); // Change style to indicate done
        btn.disabled = true;
        activateStep('step4');
    }

    /* --- STEP 5: RETRIEVAL --- */
    async function runRetrieval(btn) {
        const query = get('userQuery').value.trim();
        if (!query) return alert("Please enter a query.");

        btn.disabled = true;
        btn.innerHTML = `Searching... <span class="spinner"></span>`;
        
        await sleep(800); // Simulate network

        // Hybrid Search Simulation (Keyword + Vector Noise)
        const queryWords = query.toLowerCase().split(/\s+/);
        
        state.searchResults = state.embeddings.map(doc => {
            let score = 0;
            // 1. Keyword match boost
            queryWords.forEach(w => {
                if (w.length > 3 && doc.text.toLowerCase().includes(w)) score += 0.3;
            });
            // 2. Vector math simulation (adding consistency based on vector values)
            const vecVal = parseFloat(doc.vector[0]); 
            score += (vecVal * 0.2); 
            
            // Normalize roughly 0 to 1
            if(score > 0.98) score = 0.98;
            if(score < 0.1) score = 0.1 + (Math.random()*0.1);
            
            return { ...doc, score };
        });

        // Sort Descending
        state.searchResults.sort((a, b) => b.score - a.score);

        renderRetrievalResults();
        btn.innerHTML = `üîç Retrieve Context`;
        btn.disabled = false;
        activateStep('step5');
    }

    function updateTopKDisplay() {
        get('topKVal').innerText = get('topK').value;
        if(state.searchResults.length > 0) renderRetrievalResults();
    }

    function renderRetrievalResults() {
        const topK = parseInt(get('topK').value);
        const container = get('retrievalOutput');
        container.innerHTML = '';
        
        const subset = state.searchResults.slice(0, topK);
        
        subset.forEach(item => {
            const percentage = (item.score * 100).toFixed(1);
            const div = document.createElement('div');
            div.className = 'data-card fade-in';
            div.style.borderColor = 'var(--primary)'; // Highlight
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>Chunk ${item.id + 1}</strong>
                    <span style="font-weight:bold; color:var(--success)">${percentage}% Match</span>
                </div>
                <div style="margin: 8px 0; color: #334155;">${item.text}</div>
                <div class="score-bar-bg">
                    <div class="score-bar-fill" style="width: ${percentage}%"></div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    /* --- STEP 6: PROMPT --- */
    function buildPrompt() {
        const topK = parseInt(get('topK').value);
        const context = state.searchResults.slice(0, topK).map(c => c.text).join('\n---\n');
        const query = get('userQuery').value;

        const html = `
<span class="tag tag-sys">SYSTEM</span>
You are a helpful AI assistant. Answer the query based ONLY on the context below.

<span class="tag tag-ctx">CONTEXT</span>
${context}

<span class="tag tag-usr">USER QUERY</span>
${query}
        `;
        
        get('promptOutput').innerHTML = html.trim().replace(/\n/g, '<br>');
        activateStep('step6');
    }

    /* --- STEP 7: LLM GENERATION (CUSTOM LOGIC) --- */
    async function runLLM(btn) {
        btn.disabled = true;
        btn.innerHTML = `Generating Response... <span class="spinner"></span>`;
        
        const query = get('userQuery').value;
        
        // Simulate "Thinking" time
        await sleep(1500);

        // --- INTELLIGENCE LOGIC ---
        let response = "";

        const qLower = query.toLowerCase();

        // 1. Custom Rule: Credits
        if (qLower.includes("who created") || qLower.includes("author") || qLower.includes("developer")) {
            response = "This enterprise RAG visualization tool was engineered by an expert developer to demonstrate the capabilities of semantic search and LLM context injection.";
        }
        // 2. Custom Rule: Weather
        else if (qLower.includes("weather") || qLower.includes("temperature")) {
            response = "I cannot provide real-time weather data. As a RAG system, I am limited to the information provided in the Knowledge Base (Source Text) above.";
        }
        // 3. Contextual Rule: Hallucinations
        else if (qLower.includes("hallucination")) {
            response = "According to the provided context, RAG reduces hallucinations by fetching relevant data from external sources and ensuring the model relies on up-to-date information instead of solely on training data.";
        }
        // 4. Contextual Rule: Chunking/Vectors
        else if (qLower.includes("chunk") || qLower.includes("vector")) {
            response = "The context explains that RAG splits documents into chunks and turns them into vectors. This allows the system to retrieve the most similar chunks to a user's query.";
        }
        // 5. Fallback (Generic RAG response)
        else {
            response = "Based on the retrieved context, RAG (Retrieval-Augmented Generation) enhances Large Language Models by fetching relevant external data before generating an answer. This ensures the response is grounded in specific, up-to-date information provided in the source text.";
        }
        // ---------------------------

        const outputBox = get('llmOutput');
        outputBox.classList.remove('hidden');
        outputBox.innerHTML = '';
        
        btn.innerHTML = `‚ú® Regenerate Answer`;
        btn.disabled = false;
        activateStep('step7');

        // Typewriter effect
        let i = 0;
        function type() {
            if (i < response.length) {
                outputBox.innerHTML += response.charAt(i);
                i++;
                setTimeout(type, 20); // Typing speed
            }
        }
        type();
    }
</script>

</body>
</html>
