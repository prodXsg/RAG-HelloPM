<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG OS V4 (Stable)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #f8fafc;       
            --bg-sidebar: #ffffff;    
            --bg-card: #ffffff;       
            --primary: #2563eb;       
            --primary-subtle: #eff6ff; 
            --text-main: #0f172a;     
            --text-muted: #64748b;    
            --border: #e2e8f0;        
            --success: #10b981;  
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 250px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
        }

        .brand {
            font-size: 1.2rem; font-weight: 800; color: var(--text-main);
            margin-bottom: 30px; display: flex; align-items: center; gap: 10px;
        }
        .brand span { color: var(--primary); }

        .nav-item {
            padding: 12px; border-radius: 8px; font-size: 0.9rem;
            color: var(--text-muted); cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 10px; font-weight: 500;
        }
        .nav-item:hover { background: var(--bg-body); color: var(--text-main); }
        .nav-item.active { background: var(--primary-subtle); color: var(--primary); font-weight: 600; }
        .nav-item.disabled { opacity: 0.5; pointer-events: none; }

        /* --- MAIN --- */
        .main {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            scroll-behavior: smooth;
        }

        .container { max-width: 800px; margin: 0 auto; }

        /* --- CARDS --- */
        .step-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: var(--shadow);
            opacity: 0.4;
            pointer-events: none;
            filter: grayscale(1);
            transition: all 0.3s ease;
        }
        .step-card.active { opacity: 1; pointer-events: all; filter: grayscale(0); border-color: #cbd5e1; }

        h2 { font-size: 1.1rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .step-badge { 
            background: var(--text-main); color: white; width: 24px; height: 24px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 0.75rem; 
        }

        /* --- INPUTS --- */
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }
        textarea, input {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 8px; font-family: inherit; font-size: 0.95rem;
            transition: 0.2s; background: #fff;
        }
        textarea:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* --- BUTTONS --- */
        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 20px; border-radius: 8px; font-weight: 600;
            cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
            font-size: 0.9rem; transition: 0.2s;
        }
        .btn:hover { background: #1d4ed8; transform: translateY(-1px); }
        .btn:disabled { background: var(--text-muted); transform: none; cursor: not-allowed; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { border-color: var(--text-main); }

        /* --- VISUALS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .chunk-box {
            border: 1px solid var(--border); padding: 15px; border-radius: 8px;
            font-size: 0.85rem; background: #f8fafc; word-wrap: break-word;
        }
        .vector-text {
            font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;
            color: var(--text-muted); margin-top: 5px; background: #e2e8f0; padding: 4px; border-radius: 4px;
        }

        /* --- QUERY INPUT (THE MISSING PIECE) --- */
        .big-input {
            font-size: 1.1rem; padding: 15px; border: 2px solid var(--border);
        }
        .big-input:focus { border-color: var(--primary); }

        /* --- TERMINAL & OUTPUT --- */
        .terminal {
            background: #1e293b; color: #e2e8f0; padding: 20px;
            border-radius: 8px; font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem; white-space: pre-wrap; line-height: 1.6;
        }
        
        .llm-output {
            background: #f0fdf4; border: 1px solid #bbf7d0; border-left: 5px solid #10b981;
            padding: 25px; border-radius: 8px; font-size: 1rem; color: #14532d;
            line-height: 1.6; margin-top: 10px; 
            white-space: pre-wrap; /* CRITICAL FOR SPACING BUG */
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><span>âš¡</span> RAG OS V4</div>
        <div class="nav-item active" id="nav1">1. Ingest</div>
        <div class="nav-item" id="nav2">2. Chunk</div>
        <div class="nav-item" id="nav3">3. Embed</div>
        <div class="nav-item" id="nav4">4. Query</div>
        <div class="nav-item" id="nav5">5. Retrieve</div>
        <div class="nav-item" id="nav6">6. Prompt</div>
        <div class="nav-item" id="nav7">7. Generate</div>
    </div>

    <div class="main">
        <div class="container">
            
            <!-- STEP 1: INGEST -->
            <div id="step1" class="step-card active">
                <h2><span class="step-badge">1</span> Source Data</h2>
                <label>Paste Text (Knowledge Base)</label>
                <textarea id="sourceText" rows="5">RAG (Retrieval-Augmented Generation) is a technique that enhances Large Language Models by fetching relevant data from external sources before generating an answer. Instead of relying solely on training data, RAG splits documents into chunks, turns them into vectors, and retrieves the most similar chunks to the user's query. This process reduces hallucinations and ensures the model has up-to-date information.</textarea>
                
                <div style="display:flex; gap: 15px; margin-top: 15px;">
                    <div style="flex:1">
                        <label>Chunk Size</label>
                        <input type="number" id="chunkSize" value="100">
                    </div>
                    <div style="flex:1">
                        <label>Overlap</label>
                        <input type="number" id="chunkOverlap" value="20">
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn" onclick="runChunking()">Next: Chunk Text &rarr;</button>
                </div>
            </div>

            <!-- STEP 2: CHUNK -->
            <div id="step2" class="step-card">
                <h2><span class="step-badge">2</span> Data Chunking</h2>
                <div id="chunksOutput" class="grid"></div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn" onclick="runEmbeddings(this)">Next: Generate Vectors &rarr;</button>
                </div>
            </div>

            <!-- STEP 3: EMBED -->
            <div id="step3" class="step-card">
                <h2><span class="step-badge">3</span> Vector Embeddings</h2>
                <div id="vectorsOutput" class="grid"></div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn" onclick="saveToDB(this)">Next: Save to Index &rarr;</button>
                </div>
            </div>

            <!-- STEP 4: QUERY (DEDICATED STEP) -->
            <div id="step4" class="step-card">
                <h2><span class="step-badge">4</span> User Query</h2>
                <p style="color:var(--text-muted); margin-bottom:15px;">Now that the data is indexed, enter a question to search against it.</p>
                
                <input type="text" id="userQuery" class="big-input" value="How does RAG reduce hallucinations?">
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn" onclick="runRetrieval(this)">Next: Run Semantic Search &rarr;</button>
                </div>
            </div>

            <!-- STEP 5: RETRIEVE -->
            <div id="step5" class="step-card">
                <h2><span class="step-badge">5</span> Retrieval Results</h2>
                <div style="margin-bottom:15px; display:flex; justify-content:space-between;">
                    <label>Top Matches (K)</label>
                    <input type="range" min="1" max="3" value="2" id="topK" onchange="document.getElementById('kVal').innerText=this.value">
                    <span id="kVal">2</span>
                </div>
                <div id="retrievalOutput" class="grid"></div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn" onclick="buildPrompt()">Next: Construct Prompt &rarr;</button>
                </div>
            </div>

            <!-- STEP 6: PROMPT -->
            <div id="step6" class="step-card">
                <h2><span class="step-badge">6</span> System Prompt</h2>
                <div id="promptOutput" class="terminal"></div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn" onclick="runLLM(this)">Next: Generate Answer &rarr;</button>
                </div>
            </div>

            <!-- STEP 7: GENERATE -->
            <div id="step7" class="step-card">
                <h2><span class="step-badge">7</span> AI Response</h2>
                <div id="llmOutput" class="llm-output hidden"></div>
            </div>

        </div>
    </div>

<script>
    // --- STATE ---
    const state = { chunks: [], embeddings: [], results: [] };
    const get = id => document.getElementById(id);
    const delay = ms => new Promise(r => setTimeout(r, ms));

    function nextStep(current, next) {
        // Activate Card
        get(next).classList.add('active');
        get(next).scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Update Sidebar
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        get('nav' + next.replace('step', '')).classList.add('active');
    }

    // 1. CHUNK
    function runChunking() {
        const text = get('sourceText').value.trim();
        const size = parseInt(get('chunkSize').value);
        const overlap = parseInt(get('chunkOverlap').value);

        if(!text) return alert("Please enter text");
        
        state.chunks = [];
        let i = 0;
        while(i < text.length) {
            state.chunks.push(text.slice(i, i+size));
            if(i+size >= text.length) break;
            i += (size - overlap);
        }

        const out = get('chunksOutput');
        out.innerHTML = '';
        state.chunks.forEach((c, idx) => {
            out.innerHTML += `<div class="chunk-box"><strong>#${idx+1}</strong><br>${c}</div>`;
        });

        nextStep('step1', 'step2');
    }

    // 2. EMBED
    async function runEmbeddings(btn) {
        btn.innerHTML = "Processing...";
        await delay(500);

        state.embeddings = state.chunks.map((t, i) => ({
            id: i, text: t, vector: Array.from({length: 4}, () => Math.random().toFixed(3))
        }));

        const out = get('vectorsOutput');
        out.innerHTML = '';
        state.embeddings.forEach(item => {
            out.innerHTML += `
                <div class="chunk-box">
                    <strong>#${item.id+1}</strong>
                    <div class="vector-text">[${item.vector.join(', ')}]</div>
                </div>`;
        });

        btn.innerHTML = "Done";
        nextStep('step2', 'step3');
    }

    // 3. SAVE
    async function saveToDB(btn) {
        btn.innerHTML = "Indexing...";
        await delay(500);
        btn.innerHTML = "Saved";
        btn.disabled = true;
        nextStep('step3', 'step4');
    }

    // 4. RETRIEVE
    async function runRetrieval(btn) {
        const query = get('userQuery').value.toLowerCase();
        if(!query) return alert("Please enter a query");
        
        btn.innerHTML = "Searching...";
        await delay(800);

        // Score logic
        state.results = state.embeddings.map(doc => {
            let score = 0.1;
            query.split(' ').forEach(w => {
                if(w.length > 3 && doc.text.toLowerCase().includes(w)) score += 0.4;
            });
            return { ...doc, score: score + (Math.random()*0.1) };
        }).sort((a,b) => b.score - a.score);

        const out = get('retrievalOutput');
        out.innerHTML = '';
        const k = parseInt(get('topK').value);
        
        state.results.slice(0, k).forEach(item => {
            const pct = (item.score * 100).toFixed(0);
            out.innerHTML += `
                <div class="chunk-box" style="border-color:var(--success)">
                    <div style="display:flex; justify-content:space-between">
                        <strong>#${item.id+1}</strong>
                        <span style="color:var(--success); font-weight:bold">${pct}% Match</span>
                    </div>
                    <div style="margin-top:5px">${item.text}</div>
                </div>`;
        });

        btn.innerHTML = "Done";
        nextStep('step4', 'step5');
    }

    // 5. PROMPT
    function buildPrompt() {
        const k = parseInt(get('topK').value);
        const context = state.results.slice(0, k).map(c => c.text).join('\n---\n');
        const query = get('userQuery').value;

        if(!context) return alert("Retrieval failed. No context found.");

        const prompt = `SYSTEM: Answer based on context only.

CONTEXT:
${context}

QUERY:
${query}`;

        get('promptOutput').innerText = prompt;
        nextStep('step5', 'step6');
    }

    // 6. GENERATE (FIXED SPACING BUG)
    async function runLLM(btn) {
        btn.innerHTML = "Generating...";
        await delay(1200);

        const query = get('userQuery').value.toLowerCase();
        let ans = "Based on the retrieved context, RAG improves AI models by fetching relevant external data.";

        if(query.includes("who created")) ans = "This tool was created by a developer to fix the bugs you found!";
        if(query.includes("hallucination")) ans = "RAG reduces hallucinations by grounding the model's answer in specific, retrieved facts rather than training memory.";
        if(query.includes("chunk")) ans = "Chunking splits text into smaller pieces so the search engine can find precise matches.";

        const out = get('llmOutput');
        out.classList.remove('hidden');
        out.textContent = ""; // Clear
        
        let i = 0;
        
        // FIXED TYPEWRITER LOOP
        function type() {
            if(i < ans.length) {
                out.textContent += ans.charAt(i); // Use textContent for safety
                i++;
                setTimeout(type, 20);
            }
        }
        type();

        btn.innerHTML = "Regenerate";
        nextStep('step6', 'step7');
    }

</script>
</body>
</html>
