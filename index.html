<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualization of RAG Process</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            /* --- COLOR PALETTE (Clean Professional) --- */
            --bg-body: #f8fafc;       
            --bg-sidebar: #ffffff;    
            --bg-card: #ffffff;       
            
            --primary: #2563eb;       
            --primary-light: #eff6ff; 
            
            --text-main: #0f172a;     
            --text-muted: #64748b;    
            --border: #e2e8f0;        
            
            --success: #10b981;  
            --radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden; 
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 20;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand-icon {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
        }

        .nav-steps { list-style: none; display: flex; flex-direction: column; gap: 4px; }
        
        .nav-item {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 12px;
        }

        .nav-item:hover { background-color: var(--bg-body); color: var(--text-main); }
        
        .nav-item.active { 
            background-color: var(--primary-light); 
            color: var(--primary); 
            font-weight: 600; 
        }

        /* --- MAIN AREA --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ANALYTICS BAR */
        .analytics-bar {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 16px 40px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .stat-item { display: flex; flex-direction: column; gap: 2px; border-right: 1px solid var(--border); }
        .stat-item:last-child { border: none; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--text-main); font-family: 'JetBrains Mono', monospace; }

        /* WORKSPACE */
        .workspace {
            flex: 1;
            overflow-y: auto;
            padding: 40px 60px;
            scroll-behavior: smooth;
        }

        .header-area { margin-bottom: 40px; }
        h1 { font-size: 1.8rem; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 8px; }
        .subtitle { color: var(--text-muted); font-size: 1rem; }

        /* CARDS */
        .step-section {
            max-width: 800px;
            margin: 0 auto 50px auto;
            opacity: 0.4;
            filter: grayscale(1);
            pointer-events: none;
            transition: all 0.4s ease;
        }
        .step-section.active { opacity: 1; filter: grayscale(0); pointer-events: all; }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 32px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        /* TABS */
        .tab-group { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .tab-btn {
            padding: 10px 0; margin-right: 20px;
            background: none; border: none;
            font-weight: 600; color: var(--text-muted);
            cursor: pointer; border-bottom: 2px solid transparent;
        }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* VISUALS */
        .drop-zone {
            border: 2px dashed var(--border); border-radius: 8px;
            padding: 30px; text-align: center; background: #f8fafc;
            cursor: pointer; transition: 0.2s;
        }
        .drop-zone:hover { border-color: var(--primary); background: #eff6ff; }
        
        .grid-chunks { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-top: 20px; }
        
        .chunk-card {
            background: white; border: 1px solid var(--border);
            border-radius: 8px; padding: 16px; font-size: 0.85rem;
            color: var(--text-muted); transition: 0.2s;
        }
        .chunk-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); color: var(--text-main); }

        .vector-code { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; background: #f1f5f9; padding: 6px; border-radius: 4px; margin-top: 8px; word-break: break-all; }

        textarea, input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 0.9rem; }
        textarea:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        .btn {
            background-color: var(--primary); color: white;
            border: none; padding: 10px 20px; border-radius: 8px;
            font-weight: 600; font-size: 0.9rem; cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { background-color: #1d4ed8; }
        .btn:disabled { background-color: var(--text-muted); cursor: not-allowed; }

        .ai-response { background: #f0fdf4; border: 1px solid #bbf7d0; border-left: 4px solid #10b981; padding: 24px; border-radius: 8px; color: #064e3b; margin-top: 10px; line-height: 1.6; }
        .terminal { background: #f8fafc; border: 1px solid var(--border); padding: 20px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }

        .hidden { display: none !important; }
        .loader { width: 14px; height: 14px; border: 2px solid white; border-bottom-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand">
            <div class="brand-icon"><span class="material-icons-round" style="font-size: 18px">view_in_ar</span></div>
            <div>RAG Visualizer</div>
        </div>
        
        <ul class="nav-steps">
            <li class="nav-item active" onclick="scrollToStep('step1')">
                <span class="material-icons-round" style="font-size:18px">upload_file</span> Ingestion
            </li>
            <li class="nav-item" onclick="scrollToStep('step2')">
                <span class="material-icons-round" style="font-size:18px">content_cut</span> Chunking
            </li>
            <li class="nav-item" onclick="scrollToStep('step3')">
                <span class="material-icons-round" style="font-size:18px">data_array</span> Embeddings
            </li>
            <li class="nav-item" onclick="scrollToStep('step4')">
                <span class="material-icons-round" style="font-size:18px">question_answer</span> User Query
            </li>
            <li class="nav-item" onclick="scrollToStep('step5')">
                <span class="material-icons-round" style="font-size:18px">search</span> Retrieval
            </li>
            <li class="nav-item" onclick="scrollToStep('step6')">
                <span class="material-icons-round" style="font-size:18px">integration_instructions</span> Prompting
            </li>
            <li class="nav-item" onclick="scrollToStep('step7')">
                <span class="material-icons-round" style="font-size:18px">auto_awesome</span> Generation
            </li>
        </ul>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        
        <!-- ANALYTICS -->
        <div class="analytics-bar">
            <div class="stat-item">
                <div class="stat-label">Source Tokens</div>
                <div class="stat-value" id="statTokens">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Est. Cost</div>
                <div class="stat-value" id="statCost">$0.00</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">System Latency</div>
                <div class="stat-value" id="statLatency">0ms</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Vector Count</div>
                <div class="stat-value" id="statVectors">0</div>
            </div>
        </div>

        <div class="workspace">
            <div class="header-area">
                <h1>Visualization of RAG Process</h1>
                <p class="subtitle">An interactive demonstration of Retrieval-Augmented Generation workflows.</p>
            </div>

            <!-- STEP 1: INGESTION -->
            <section id="step1" class="step-section active">
                <div class="card">
                    <div style="margin-bottom:20px; font-weight:600;">1. Knowledge Base Ingestion</div>
                    
                    <div class="tab-group">
                        <button class="tab-btn active" onclick="switchTab('text')">Paste Text</button>
                        <button class="tab-btn" onclick="switchTab('file')">Upload File</button>
                    </div>

                    <div id="mode-text">
                        <textarea id="sourceText" rows="6" oninput="updateAnalytics()">RAG (Retrieval-Augmented Generation) is a technique that enhances Large Language Models by fetching relevant data from external sources before generating an answer. Instead of relying solely on training data, RAG splits documents into chunks, turns them into vectors, and retrieves the most similar chunks to the user's query.</textarea>
                    </div>

                    <div id="mode-file" class="hidden">
                        <div class="drop-zone" id="dropZone">
                            <span class="material-icons-round" style="font-size:36px; color:#94a3b8">cloud_upload</span>
                            <div style="margin-top:10px; font-size:0.9rem; color:#64748b">Drag & Drop files or Click to Browse</div>
                            <input type="file" id="fileInput" style="display:none" accept=".txt,.md,.json">
                        </div>
                        <div id="fileName" class="hidden" style="margin-top:10px; font-weight:600; color:var(--primary); text-align:center;"></div>
                    </div>

                    <div style="display:flex; gap:20px; margin-top:20px;">
                        <div style="flex:1">
                            <label style="font-size:0.8rem; font-weight:600; margin-bottom:5px; display:block">Chunk Size</label>
                            <input type="number" id="chunkSize" value="100">
                        </div>
                        <div style="flex:1">
                            <label style="font-size:0.8rem; font-weight:600; margin-bottom:5px; display:block">Overlap</label>
                            <input type="number" id="chunkOverlap" value="20">
                        </div>
                        <div style="flex:1; display:flex; align-items:flex-end;">
                            <button class="btn" onclick="runChunking()">Process Data</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STEP 2: CHUNKING -->
            <section id="step2" class="step-section">
                <div class="card">
                    <div style="margin-bottom:15px; font-weight:600;">2. Data Chunking</div>
                    <div id="chunksOutput" class="grid-chunks"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="runEmbeddings(this)">Vectorize Chunks</button>
                    </div>
                </div>
            </section>

            <!-- STEP 3: EMBEDDINGS -->
            <section id="step3" class="step-section">
                <div class="card">
                    <div style="margin-bottom:15px; font-weight:600;">3. Vector Embeddings</div>
                    <div id="vectorsOutput" class="grid-chunks"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="saveVectors(this)">Save to Vector DB</button>
                    </div>
                </div>
            </section>

            <!-- STEP 4: USER QUERY -->
            <section id="step4" class="step-section">
                <div class="card">
                    <div style="margin-bottom:15px; font-weight:600;">4. User Query</div>
                    <input type="text" id="userQuery" value="How does RAG reduce hallucinations?">
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="scrollToStep('step5')">Proceed to Retrieval</button>
                    </div>
                </div>
            </section>

            <!-- STEP 5: RETRIEVAL -->
            <section id="step5" class="step-section">
                <div class="card">
                    <div style="margin-bottom:15px; font-weight:600;">5. Semantic Retrieval</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <span style="font-size:0.9rem; color:var(--text-muted)">Top K Results: <strong id="topKVal" style="color:var(--primary)">2</strong></span>
                        <input type="range" id="topK" min="1" max="5" value="2" oninput="document.getElementById('topKVal').innerText=this.value">
                    </div>
                    <div style="text-align:center; margin-bottom:20px;">
                        <button class="btn" onclick="runRetrieval(this)">Execute Vector Search</button>
                    </div>
                    <div id="retrievalOutput" class="grid-chunks"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="buildPrompt()">Construct Prompt</button>
                    </div>
                </div>
            </section>

            <!-- STEP 6: PROMPTING -->
            <section id="step6" class="step-section">
                <div class="card">
                    <div style="margin-bottom:15px; font-weight:600;">6. Context Injection</div>
                    <div id="promptOutput" class="terminal"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="runLLM(this)">Send to LLM</button>
                    </div>
                </div>
            </section>

            <!-- STEP 7: GENERATION -->
            <section id="step7" class="step-section">
                <div class="card">
                    <div style="margin-bottom:15px; font-weight:600;">7. AI Response</div>
                    <div id="llmOutput" class="ai-response hidden"></div>
                </div>
            </section>

        </div>
    </div>

<script>
    /* --- LOGIC ENGINE --- */
    const state = { chunks: [], embeddings: [], searchResults: [] };
    const get = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    
    // --- ANALYTICS ---
    function updateAnalytics() {
        const text = get('sourceText').value || "";
        const tokens = Math.ceil(text.length / 4);
        get('statTokens').innerText = tokens.toLocaleString();
        get('statCost').innerText = "$" + ((tokens/1000)*0.0005).toFixed(4);
    }
    
    function setLatency(start) {
        get('statLatency').innerText = (Date.now() - start) + "ms";
    }

    // --- TABS & FILES ---
    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if(mode === 'text') { get('mode-text').classList.remove('hidden'); get('mode-file').classList.add('hidden'); }
        else { get('mode-text').classList.add('hidden'); get('mode-file').classList.remove('hidden'); }
    }

    const dropZone = get('dropZone');
    const fileInput = get('fileInput');
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleFile(e.target.files[0]);
    
    function handleFile(file) {
        if(!file) return;
        get('fileName').innerText = file.name; get('fileName').classList.remove('hidden');
        const reader = new FileReader();
        reader.onload = (e) => { get('sourceText').value = e.target.result; updateAnalytics(); switchTab('text'); };
        reader.readAsText(file);
    }

    // --- NAV ---
    function scrollToStep(id) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Find closest matching nav item based on onclick attribute
        const navItem = document.querySelector(`.nav-item[onclick="scrollToStep('${id}')"]`);
        if(navItem) navItem.classList.add('active');
        
        const el = get(id);
        el.classList.add('active');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // --- PROCESSING ---
    function runChunking() {
        const start = Date.now();
        const text = get('sourceText').value.trim();
        const size = parseInt(get('chunkSize').value);
        const overlap = parseInt(get('chunkOverlap').value);
        if(!text) return alert("Enter text first.");

        state.chunks = [];
        let i = 0;
        while(i < text.length) {
            state.chunks.push(text.slice(i, i+size));
            if(i+size >= text.length) break;
            i += (size - overlap);
        }

        const container = get('chunksOutput');
        container.innerHTML = '';
        state.chunks.forEach((c, idx) => {
            container.innerHTML += `<div class="chunk-card"><strong>Chunk ${idx+1}</strong><div style="margin-top:5px; color:#475569;">${c}</div></div>`;
        });
        setLatency(start); scrollToStep('step2');
    }

    async function runEmbeddings(btn) {
        const start = Date.now();
        btn.disabled = true; btn.innerHTML = `<div class="loader"></div> Processing`;
        await sleep(600);
        
        state.embeddings = state.chunks.map((t, i) => ({ id: i, text: t, vector: Array.from({length: 5}, () => Math.random().toFixed(4)) }));
        
        const container = get('vectorsOutput');
        container.innerHTML = '';
        state.embeddings.forEach(item => {
            container.innerHTML += `<div class="chunk-card"><strong>ID: ${item.id}</strong><div class="vector-code">[${item.vector.join(', ')}]</div></div>`;
        });
        setLatency(start); btn.innerHTML = "Vectorize Chunks"; btn.disabled = false; scrollToStep('step3');
    }

    async function saveVectors(btn) {
        const start = Date.now();
        btn.innerHTML = `<div class="loader"></div> Saving`;
        await sleep(400);
        get('statVectors').innerText = state.embeddings.length;
        btn.innerHTML = "Saved"; btn.disabled = true;
        setLatency(start); scrollToStep('step4');
    }

    async function runRetrieval(btn) {
        const start = Date.now();
        btn.disabled = true; btn.innerHTML = `<div class="loader"></div> Searching`;
        await sleep(800);

        const query = get('userQuery').value.toLowerCase();
        state.searchResults = state.embeddings.map(doc => {
            let score = 0.1;
            query.split(' ').forEach(w => { if(w.length>3 && doc.text.toLowerCase().includes(w)) score+=0.3; });
            score += Math.random()*0.1;
            return { ...doc, score: Math.min(score, 0.99) };
        }).sort((a,b) => b.score - a.score);

        const k = parseInt(get('topK').value);
        const container = get('retrievalOutput');
        container.innerHTML = '';
        state.searchResults.slice(0, k).forEach(item => {
            container.innerHTML += `<div class="chunk-card" style="border-color:var(--success)">
                <div style="display:flex; justify-content:space-between;"><strong>Chunk ${item.id+1}</strong><span style="color:var(--success); font-weight:bold;">${(item.score*100).toFixed(0)}%</span></div>
                <div style="font-size:0.8rem; margin-top:5px;">${item.text}</div></div>`;
        });
        setLatency(start); btn.innerHTML = "Execute Vector Search"; btn.disabled = false;
    }

    function buildPrompt() {
        const k = parseInt(get('topK').value);
        const context = state.searchResults.slice(0, k).map(c => c.text).join('\n');
        get('promptOutput').innerHTML = `<span style="color:#64748b">SYSTEM: Answer based on context.</span><br><br><span style="color:#2563eb">CONTEXT:</span><br>${context}<br><br><span style="color:#10b981">QUERY:</span><br>${get('userQuery').value}`;
        scrollToStep('step6');
    }

    async function runLLM(btn) {
        btn.disabled = true; btn.innerHTML = `<div class="loader"></div> Generating`;
        await sleep(1500);
        
        const q = get('userQuery').value.toLowerCase();
        let ans = "Based on the retrieved context, RAG (Retrieval-Augmented Generation) uses external data to ground the LLM's response.";
        if(q.includes("who created")) ans = "This RAG Visualizer was built by an expert developer.";
        if(q.includes("weather")) ans = "I cannot provide weather updates from the provided text context.";
        if(q.includes("hallucination")) ans = "RAG reduces hallucinations by grounding answers in retrieved data rather than training memory.";
        
        const out = get('llmOutput'); out.classList.remove('hidden'); out.innerText = "";
        let i=0; const type = () => { if(i<ans.length){ out.innerText+=ans.charAt(i); i++; setTimeout(type, 20); }}; type();
        btn.innerHTML = "Regenerate"; btn.disabled = false; scrollToStep('step7');
    }

    updateAnalytics();
</script>
</body>
</html>
