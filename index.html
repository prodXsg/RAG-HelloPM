<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise RAG Platform | V3.0 Platinum</title>
    
    <!-- FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- CHART.JS FOR ANALYTICS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* --- PLATINUM LIGHT THEME --- */
            --bg-body: #f1f5f9;       /* Slate 100 */
            --bg-sidebar: #ffffff;    /* Pure White */
            --bg-card: #ffffff;       /* Pure White */
            
            --primary: #2563eb;       /* Royal Blue */
            --primary-soft: #eff6ff;  /* Light Blue BG */
            
            --text-main: #0f172a;     /* Slate 900 */
            --text-muted: #64748b;    /* Slate 500 */
            
            --border: #e2e8f0;        /* Light Grey */
            --success: #10b981;       /* Emerald */
            --warning: #f59e0b;       /* Amber */
            
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            --radius: 12px;
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden; 
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 20;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-left: 8px;
        }
        .brand-icon { 
            background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%); 
            color: white; 
            width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        }

        .nav-group-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 0 10px 12px;
        }

        .nav-item {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 4px;
        }

        .nav-item:hover { background-color: var(--bg-body); color: var(--text-main); }
        
        .nav-item.active {
            background-color: var(--primary-soft);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-num {
            width: 20px; height: 20px;
            background: #f1f5f9;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 600;
            color: var(--text-muted);
        }
        .nav-item.active .nav-num { background: white; color: var(--primary); box-shadow: var(--shadow-sm); }

        /* --- MAIN AREA --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px 60px;
            scroll-behavior: smooth;
            position: relative;
        }

        .header-area {
            max-width: 900px;
            margin: 0 auto 40px auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        h1 { font-size: 1.75rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.03em; }
        .subtitle { color: var(--text-muted); font-size: 1rem; margin-top: 6px; }

        /* --- CARDS & GLASS EFFECT --- */
        .step-section {
            max-width: 900px;
            margin: 0 auto 50px auto;
            opacity: 0.5;
            filter: grayscale(1);
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .step-section.active {
            opacity: 1;
            filter: grayscale(0);
            pointer-events: all;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 30px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        .badge { 
            background: var(--primary-soft); 
            color: var(--primary); 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 0.7rem; 
            font-weight: 700; 
            text-transform: uppercase; 
        }

        /* --- INPUTS & FILE UPLOAD --- */
        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px; }

        textarea, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            transition: 0.2s;
            background: white;
        }
        textarea:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        .file-drop-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: 0.2s;
            cursor: pointer;
            background: #f8fafc;
        }
        .file-drop-zone:hover { border-color: var(--primary); background: var(--primary-soft); }
        .file-input { display: none; }

        /* --- BUTTONS --- */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }
        .btn:hover { background-color: #1d4ed8; transform: translateY(-1px); box-shadow: var(--shadow-lg); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--text-muted); transform: none; }

        /* --- VISUALS --- */
        .grid-chunks { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; margin-top: 20px; }
        .chunk-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 16px; font-size: 0.85rem; line-height: 1.5; color: var(--text-muted); }
        .chunk-card:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); color: var(--text-main); }
        
        .vector-box { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-main); background: #f1f5f9; padding: 10px; border-radius: 6px; margin-top: 8px; word-break: break-all; border: 1px solid var(--border); }
        .match-bar { height: 6px; background: #f1f5f9; border-radius: 3px; margin-top: 12px; overflow: hidden; }
        .match-fill { height: 100%; background: var(--success); width: 0%; transition: width 1s ease; }

        /* --- ANALYTICS DASHBOARD --- */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: var(--text-main); margin-top: 5px; }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }

        /* --- LLM & TERMINAL --- */
        .terminal { background: #f8fafc; color: var(--text-main); padding: 20px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; line-height: 1.6; border: 1px solid var(--border); }
        .token-sys { color: #64748b; font-weight: bold; }
        .token-user { color: #059669; font-weight: bold; }
        .token-ctx { color: #2563eb; font-weight: bold; }
        
        .ai-response { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 24px; border-radius: 8px; color: #166534; font-size: 1rem; line-height: 1.6; margin-top: 20px; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand">
            <div class="brand-icon">‚ö°</div>
            RAG Platinum
        </div>

        <div class="nav-group-title">Pipeline</div>
        
        <div class="nav-item active" onclick="switchView('pipeline', 'step1')">
            <div class="nav-num">1</div> Ingestion
        </div>
        <div class="nav-item" id="nav-step2" onclick="switchView('pipeline', 'step2')">
            <div class="nav-num">2</div> Chunking
        </div>
        <div class="nav-item" id="nav-step3" onclick="switchView('pipeline', 'step3')">
            <div class="nav-num">3</div> Embeddings
        </div>
        <div class="nav-item" id="nav-step4" onclick="switchView('pipeline', 'step4')">
            <div class="nav-num">4</div> Query
        </div>
        <div class="nav-item" id="nav-step5" onclick="switchView('pipeline', 'step5')">
            <div class="nav-num">5</div> Retrieval
        </div>
        <div class="nav-item" id="nav-step6" onclick="switchView('pipeline', 'step6')">
            <div class="nav-num">6</div> Prompting
        </div>
        <div class="nav-item" id="nav-step7" onclick="switchView('pipeline', 'step7')">
            <div class="nav-num">7</div> Generation
        </div>

        <div class="nav-group-title">Admin</div>
        
        <div class="nav-item" onclick="switchView('analytics')">
            <div class="nav-num">üìä</div> Analytics
        </div>
        
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); font-size: 0.7rem; color: var(--text-muted);">
            V3.0.0 Stable<br>Logged in as Admin
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        
        <!-- PIPELINE VIEW -->
        <div id="view-pipeline">
            <div class="header-area">
                <div>
                    <h1>RAG Architecture</h1>
                    <p class="subtitle">Interactive Retrieval-Augmented Generation visualizer.</p>
                </div>
            </div>

            <!-- STEP 1: INGESTION (WITH FILE UPLOAD) -->
            <section id="step1" class="step-section active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">1. Knowledge Base Ingestion</div>
                        <span class="badge">Input</span>
                    </div>
                    
                    <!-- NEW FILE UPLOAD SECTION -->
                    <div class="input-group">
                        <label>Import File (Optional)</label>
                        <div class="file-drop-zone" onclick="document.getElementById('fileInput').click()">
                            <span style="font-size: 1.5rem;">üìÇ</span><br>
                            <span style="color:var(--primary); font-weight:600;">Click to upload</span> or drag and drop<br>
                            <span style="font-size:0.8rem; color:var(--text-muted);">Supports .txt, .md, .json</span>
                            <input type="file" id="fileInput" class="file-input" accept=".txt,.md,.json" onchange="handleFileUpload(this)">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Source Text</label>
                        <textarea id="sourceText" rows="5">RAG (Retrieval-Augmented Generation) is a technique that enhances Large Language Models by fetching relevant data from external sources before generating an answer. Instead of relying solely on training data, RAG splits documents into chunks, turns them into vectors, and retrieves the most similar chunks to the user's query. This process reduces hallucinations and ensures the model has up-to-date information.</textarea>
                    </div>
                    <div style="display:flex; gap:20px;">
                        <div style="flex:1">
                            <label>Chunk Size</label>
                            <input type="number" id="chunkSize" value="100">
                        </div>
                        <div style="flex:1">
                            <label>Overlap</label>
                            <input type="number" id="chunkOverlap" value="20">
                        </div>
                        <div style="flex:1; display:flex; align-items:flex-end;">
                            <button class="btn" onclick="runChunking()">Start Processing</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STEP 2: CHUNKS -->
            <section id="step2" class="step-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">2. Data Chunking</div>
                        <span class="badge">Segmentation</span>
                    </div>
                    <p style="color:var(--text-muted); font-size: 0.9rem;">Documents sliced into manageable tokens.</p>
                    <div id="chunksOutput" class="grid-chunks"></div>
                    <div style="margin-top: 25px; text-align: right;">
                        <button class="btn" onclick="runEmbeddings(this)">Vectorize Chunks &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- STEP 3: VECTORS -->
            <section id="step3" class="step-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">3. Vector Embeddings</div>
                        <span class="badge">Math</span>
                    </div>
                    <div id="vectorsOutput" class="grid-chunks"></div>
                    <div style="margin-top: 25px; text-align: right;">
                        <button class="btn" onclick="saveVectors(this)">Save to Vector DB &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- STEP 4: QUERY -->
            <section id="step4" class="step-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">4. User Query</div>
                        <span class="badge">Interaction</span>
                    </div>
                    <div class="input-group">
                        <label>Enter Question</label>
                        <input type="text" id="userQuery" value="How does RAG reduce hallucinations?">
                    </div>
                    <button class="btn" onclick="runRetrieval(this)">üîç Execute Search</button>
                </div>
            </section>

            <!-- STEP 5: RETRIEVAL -->
            <section id="step5" class="step-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">5. Semantic Retrieval</div>
                        <span class="badge">Cosine Similarity</span>
                    </div>
                    <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                        <label>Top Results (K): <span id="topKVal" style="color:var(--primary)">2</span></label>
                        <input type="range" id="topK" min="1" max="5" value="2" oninput="updateTopK()">
                    </div>
                    <div id="retrievalOutput" class="grid-chunks"></div>
                    <div style="margin-top: 25px; text-align: right;">
                        <button class="btn" onclick="buildPrompt()">Construct System Prompt &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- STEP 6: PROMPT -->
            <section id="step6" class="step-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">6. Context Injection</div>
                        <span class="badge">Engineering</span>
                    </div>
                    <div id="promptOutput" class="terminal"></div>
                    <div style="margin-top: 25px; text-align: right;">
                        <button class="btn" onclick="runLLM(this)">‚ö° Send to LLM</button>
                    </div>
                </div>
            </section>

            <!-- STEP 7: GENERATION -->
            <section id="step7" class="step-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">7. AI Generation</div>
                        <span class="badge">Output</span>
                    </div>
                    <div id="llmOutput" class="ai-response hidden"></div>
                </div>
            </section>
        </div>

        <!-- ANALYTICS VIEW -->
        <div id="view-analytics" class="hidden">
            <div class="header-area">
                <div>
                    <h1>System Analytics</h1>
                    <p class="subtitle">Real-time performance metrics and usage statistics.</p>
                </div>
            </div>

            <div class="analytics-grid">
                <!-- Stat Cards -->
                <div class="stat-card">
                    <div class="stat-label">Total Tokens Processed</div>
                    <div class="stat-val" id="stat-tokens">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Retrieval Score</div>
                    <div class="stat-val" id="stat-score">0.00</div>
                </div>
            </div>

            <div class="analytics-grid">
                <!-- Charts -->
                <div class="card">
                    <div class="card-title" style="margin-bottom:15px;">System Latency (ms)</div>
                    <canvas id="latencyChart"></canvas>
                </div>
                <div class="card">
                    <div class="card-title" style="margin-bottom:15px;">Chunk Distribution</div>
                    <canvas id="chunkChart"></canvas>
                </div>
            </div>
        </div>

    </main>

<script>
    /* --- PLATINUM LOGIC ENGINE --- */
    
    // Global State & Analytics Data
    const state = { chunks: [], embeddings: [], searchResults: [] };
    const analytics = {
        totalTokens: 0,
        avgScore: 0,
        queryCount: 0,
        latencies: [], // [embeddingTime, retrievalTime, llmTime]
        chunkCounts: []
    };

    // Chart Instances
    let latencyChartInstance = null;
    let chunkChartInstance = null;
    
    // Utils
    const get = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    /* --- VIEW SWITCHER --- */
    function switchView(viewName, stepId = null) {
        // Toggle Main Views
        if(viewName === 'analytics') {
            get('view-pipeline').classList.add('hidden');
            get('view-analytics').classList.remove('hidden');
            renderAnalytics();
            // Sidebar active state
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        } else {
            get('view-pipeline').classList.remove('hidden');
            get('view-analytics').classList.add('hidden');
            
            // Scroll to specific step if requested
            if(stepId) {
                scrollToStep(stepId);
            }
        }
    }

    function scrollToStep(id) {
        // Sidebar active state
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navItem = document.querySelector(`.nav-item[onclick*="${id}"]`);
        if(navItem) navItem.classList.add('active');

        // Show Section
        document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active')); // optional: close others
        const el = get(id);
        el.classList.add('active');
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /* --- FILE UPLOAD LOGIC --- */
    function handleFileUpload(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            get('sourceText').value = e.target.result;
            // Visual Feedback
            input.parentElement.style.borderColor = 'var(--success)';
            input.parentElement.style.backgroundColor = '#f0fdf4';
            setTimeout(() => {
                input.parentElement.style = ''; // Reset after 1s
            }, 1500);
        };
        reader.readAsText(file);
    }

    /* --- PIPELINE FUNCTIONS --- */

    function runChunking() {
        const text = get('sourceText').value.trim();
        const size = parseInt(get('chunkSize').value);
        const overlap = parseInt(get('chunkOverlap').value);

        if(!text) return alert("Please enter text.");
        
        // 1. Logic
        state.chunks = [];
        let i = 0;
        while (i < text.length) {
            state.chunks.push(text.slice(i, i + size));
            if (i + size >= text.length) break;
            i += (size - overlap);
        }

        // 2. Update Analytics
        analytics.totalTokens += Math.ceil(text.length / 4); // Approx 4 chars = 1 token
        analytics.chunkCounts.push(state.chunks.length);

        // 3. Render
        const container = get('chunksOutput');
        container.innerHTML = '';
        state.chunks.forEach((c, idx) => {
            container.innerHTML += `
                <div class="chunk-card fade-in">
                    <strong style="color:var(--primary)">Chunk ${idx+1}</strong>
                    <div style="margin-top:8px;">${c}</div>
                </div>`;
        });

        scrollToStep('step2');
    }

    async function runEmbeddings(btn) {
        const start = Date.now();
        btn.disabled = true;
        btn.innerHTML = `<span class="loader"></span> Processing`;
        await sleep(600); // Simulate Work

        state.embeddings = state.chunks.map((text, i) => {
            const vec = Array.from({length: 5}, () => Math.random().toFixed(4));
            return { id: i, text, vector: vec };
        });

        // Analytics
        const duration = Date.now() - start;
        analytics.latencies.push({ type: 'Embedding', ms: duration });

        const container = get('vectorsOutput');
        container.innerHTML = '';
        state.embeddings.forEach(item => {
            container.innerHTML += `
                <div class="chunk-card fade-in">
                    <strong>ID: ${item.id+1}</strong>
                    <div class="vector-box">[${item.vector.join(', ')}]</div>
                </div>`;
        });

        btn.innerHTML = "Done";
        scrollToStep('step3');
    }

    async function saveVectors(btn) {
        btn.innerHTML = `<span class="loader"></span> Indexing`;
        await sleep(500);
        localStorage.setItem('rag_vectors', JSON.stringify(state.embeddings));
        btn.innerHTML = "Saved to DB";
        btn.disabled = true;
        scrollToStep('step4');
    }

    async function runRetrieval(btn) {
        const start = Date.now();
        const query = get('userQuery').value.toLowerCase();
        if(!query) return alert("Enter a query");

        btn.disabled = true;
        btn.innerHTML = `<span class="loader"></span> Searching`;
        await sleep(800);

        // Logic
        state.searchResults = state.embeddings.map(doc => {
            let score = 0.1;
            const words = query.split(' ');
            words.forEach(w => {
                if(w.length > 3 && doc.text.toLowerCase().includes(w)) score += 0.3;
            });
            score += parseFloat(doc.vector[0]) * 0.1; // Vector noise
            if(score > 0.99) score = 0.99;
            return { ...doc, score };
        }).sort((a,b) => b.score - a.score);

        // Analytics: Average Score
        const topK = parseInt(get('topK').value);
        const topDocs = state.searchResults.slice(0, topK);
        const currentAvg = topDocs.reduce((acc, curr) => acc + curr.score, 0) / topDocs.length;
        
        // Rolling average update
        analytics.queryCount++;
        analytics.avgScore = ((analytics.avgScore * (analytics.queryCount - 1)) + currentAvg) / analytics.queryCount;
        
        // Latency
        analytics.latencies.push({ type: 'Retrieval', ms: Date.now() - start });

        renderResults();
        btn.innerHTML = "Search Complete";
        btn.disabled = false;
        scrollToStep('step5');
    }

    function updateTopK() {
        get('topKVal').innerText = get('topK').value;
        if(state.searchResults.length) renderResults();
    }

    function renderResults() {
        const k = parseInt(get('topK').value);
        const container = get('retrievalOutput');
        container.innerHTML = '';
        state.searchResults.slice(0, k).forEach(item => {
            const pct = (item.score * 100).toFixed(0);
            container.innerHTML += `
                <div class="chunk-card fade-in" style="border-color:var(--primary)">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong>Chunk ${item.id+1}</strong>
                        <span style="color:var(--success); font-weight:bold;">${pct}% Match</span>
                    </div>
                    <div style="color:var(--text-main); font-size:0.85rem;">${item.text}</div>
                    <div class="match-bar"><div class="match-fill" style="width:${pct}%"></div></div>
                </div>`;
        });
    }

    function buildPrompt() {
        const k = parseInt(get('topK').value);
        const context = state.searchResults.slice(0, k).map(c => c.text).join('\n---\n');
        const query = get('userQuery').value;

        const html = `
<span class="token-sys">SYSTEM: You are a helpful assistant. Use the context below.</span>

<span class="token-ctx">CONTEXT:
${context}</span>

<span class="token-user">USER QUERY:
${query}</span>`;

        get('promptOutput').innerHTML = html.replace(/\n/g, '<br>');
        scrollToStep('step6');
    }

    async function runLLM(btn) {
        const start = Date.now();
        btn.disabled = true;
        btn.innerHTML = `<span class="loader"></span> Generating`;
        await sleep(1500);

        const query = get('userQuery').value.toLowerCase();
        let ans = "";

        // Custom Logic Preserved
        if (query.includes("who created") || query.includes("author")) {
            ans = "This tool was built by an expert developer to visually demonstrate Enterprise RAG architecture.";
        } else if (query.includes("weather")) {
            ans = "I cannot determine the weather. My knowledge is strictly limited to the provided context chunks above.";
        } else {
            ans = "Based on the retrieved context, RAG improves model accuracy by injecting relevant external data into the prompt before generation.";
        }

        analytics.latencies.push({ type: 'Generation', ms: Date.now() - start });

        const out = get('llmOutput');
        out.classList.remove('hidden');
        out.innerText = "";
        let i = 0;
        const type = () => {
            if(i < ans.length) {
                out.innerText += ans.charAt(i);
                i++;
                setTimeout(type, 20);
            }
        };
        type();

        btn.innerHTML = "Regenerate";
        btn.disabled = false;
        scrollToStep('step7');
    }

    /* --- ANALYTICS RENDERING (CHART.JS) --- */
    function renderAnalytics() {
        // Update Text Stats
        get('stat-tokens').innerText = analytics.totalTokens.toLocaleString();
        get('stat-score').innerText = (analytics.avgScore * 100).toFixed(1) + "%";

        // Chart 1: Latency (Bar)
        const ctx1 = get('latencyChart').getContext('2d');
        if(latencyChartInstance) latencyChartInstance.destroy();
        
        const latencyData = {
            labels: analytics.latencies.map((l, i) => `${l.type} ${i+1}`),
            datasets: [{
                label: 'Latency (ms)',
                data: analytics.latencies.map(l => l.ms),
                backgroundColor: '#3b82f6',
                borderRadius: 4
            }]
        };
        latencyChartInstance = new Chart(ctx1, {
            type: 'bar',
            data: latencyData,
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // Chart 2: Chunks (Line)
        const ctx2 = get('chunkChart').getContext('2d');
        if(chunkChartInstance) chunkChartInstance.destroy();
        
        chunkChartInstance = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: analytics.chunkCounts.map((_, i) => `Run ${i+1}`),
                datasets: [{
                    label: 'Chunks Generated',
                    data: analytics.chunkCounts,
                    borderColor: '#10b981',
                    tension: 0.3,
                    fill: true,
                    backgroundColor: 'rgba(16, 185, 129, 0.1)'
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

</script>
</body>
</html>
