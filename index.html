<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG OS V6 | Interactive</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #f1f5f9;       
            --bg-sidebar: #ffffff;    
            --bg-card: #ffffff;       
            --primary: #2563eb;       
            --primary-light: #eff6ff; 
            --text-main: #0f172a;     
            --text-muted: #64748b;    
            --border: #e2e8f0;        
            --success: #10b981;  
            --radius: 12px;
            --highlight: #fef08a; /* Yellow for attention */
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden; 
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 20;
        }

        .brand {
            font-size: 1.2rem; font-weight: 800; color: var(--text-main);
            margin-bottom: 30px; display: flex; align-items: center; gap: 10px;
        }
        .brand span { color: var(--primary); }

        .nav-item {
            padding: 12px 14px; border-radius: 8px; font-size: 0.85rem;
            color: var(--text-muted); cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 12px; font-weight: 500;
        }
        .nav-item:hover { background-color: var(--bg-body); color: var(--text-main); }
        .nav-item.active { background-color: var(--primary-light); color: var(--primary); font-weight: 700; }

        /* --- MAIN LAYOUT --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .workspace {
            flex: 1;
            overflow-y: auto;
            padding: 40px 60px;
            scroll-behavior: smooth;
        }

        .header-area { margin-bottom: 40px; }
        h1 { font-size: 1.8rem; font-weight: 700; letter-spacing: -0.02em; }
        .subtitle { color: var(--text-muted); margin-top: 8px; }

        /* --- CARDS & STEPS --- */
        .step-section {
            max-width: 900px;
            margin: 0 auto 50px auto;
            opacity: 0.3;
            filter: grayscale(1);
            pointer-events: none; /* Disabled by default */
            transition: all 0.4s ease;
        }
        .step-section.active { opacity: 1; filter: grayscale(0); pointer-events: all; }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 32px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        }

        .card-header { border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        .card-title { font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .step-num { 
            background: var(--primary); color: white; width: 28px; height: 28px; 
            border-radius: 6px; display: flex; align-items: center; justify-content: center; 
            font-size: 0.9rem; font-weight: bold;
        }

        /* --- INPUTS --- */
        textarea, input {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 8px; font-family: inherit; font-size: 0.95rem; transition: 0.2s;
        }
        textarea:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        /* THE IMPORTANT QUERY INPUT */
        .query-box-wrapper {
            background: #fffbeb; /* Light yellow background */
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #fcd34d;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); }
            100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
        }

        .big-query-input {
            padding: 15px; font-size: 1.2rem; border: 1px solid #d1d5db; width: 100%; border-radius: 8px;
        }

        /* Buttons */
        .btn {
            background-color: var(--primary); color: white; border: none;
            padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        .btn:disabled { background-color: var(--text-muted); cursor: not-allowed; transform: none; }

        /* Grids */
        .grid-chunks { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; margin-top: 20px; }
        .chunk-card {
            background: white; border: 1px solid var(--border); padding: 16px; 
            border-radius: 8px; font-size: 0.85rem; color: var(--text-muted);
        }

        /* Output Areas */
        .terminal {
            background: #f8fafc; border: 1px solid var(--border); padding: 20px;
            border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;
            white-space: pre-wrap;
        }
        .ai-response {
            background: #f0fdf4; border: 1px solid #bbf7d0; border-left: 4px solid #10b981;
            padding: 24px; border-radius: 8px; color: #14532d; font-size: 1rem; line-height: 1.6;
            margin-top: 20px; 
            white-space: pre-wrap;
        }

        .hidden { display: none; }
        .loader { width: 16px; height: 16px; border: 2px solid white; border-bottom-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand"><span>âš¡</span> RAG OS V6</div>
        <div class="nav-item active" id="nav-step1">1. Ingestion</div>
        <div class="nav-item" id="nav-step2">2. Chunking</div>
        <div class="nav-item" id="nav-step3">3. Embeddings</div>
        <div class="nav-item" id="nav-step4" style="color:var(--primary); font-weight:bold;">4. USER QUERY</div>
        <div class="nav-item" id="nav-step5">5. Retrieval</div>
        <div class="nav-item" id="nav-step6">6. Prompting</div>
        <div class="nav-item" id="nav-step7">7. Generation</div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="workspace">
            <div class="header-area">
                <h1>Visual RAG Engine</h1>
                <p class="subtitle">Follow the steps to build your AI response.</p>
            </div>

            <!-- STEP 1: INGESTION -->
            <section id="step1" class="step-section active">
                <div class="card">
                    <div class="card-header"><div class="card-title"><div class="step-num">1</div> Data Ingestion</div></div>
                    <label>Source Text</label>
                    <textarea id="sourceText" rows="4">RAG (Retrieval-Augmented Generation) is a technique that enhances Large Language Models by fetching relevant data from external sources before generating an answer. Instead of relying solely on training data, RAG splits documents into chunks, turns them into vectors, and retrieves the most similar chunks to the user's query. This process reduces hallucinations and ensures the model has up-to-date information.</textarea>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="runChunking()">Next: Chunk Data &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- STEP 2: CHUNKING -->
            <section id="step2" class="step-section">
                <div class="card">
                    <div class="card-header"><div class="card-title"><div class="step-num">2</div> Chunk Inspection</div></div>
                    <div id="chunksOutput" class="grid-chunks"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="runEmbeddings(this)">Next: Create Vectors &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- STEP 3: EMBEDDINGS -->
            <section id="step3" class="step-section">
                <div class="card">
                    <div class="card-header"><div class="card-title"><div class="step-num">3</div> Vector Store</div></div>
                    <div id="vectorsOutput" class="grid-chunks"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="saveVectors(this)">Next: Save & Go to Query &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- STEP 4: USER QUERY (FOCUSED STEP) -->
            <section id="step4" class="step-section">
                <div class="card">
                    <div class="card-header"><div class="card-title"><div class="step-num">4</div> User Query</div></div>
                    <p style="margin-bottom:15px; font-weight:500;">The system is ready. Please type your question below:</p>
                    
                    <!-- HIGH VISIBILITY INPUT WRAPPER -->
                    <div class="query-box-wrapper">
                        <input type="text" id="userQuery" class="big-query-input" placeholder="Type your question here (e.g., 'What is RAG?')">
                    </div>
                    
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="runRetrieval(this)">Search Knowledge Base &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- STEP 5: RETRIEVAL -->
            <section id="step5" class="step-section">
                <div class="card">
                    <div class="card-header"><div class="card-title"><div class="step-num">5</div> Retrieval Results</div></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <label>Top Matches</label>
                        <input type="range" id="topK" min="1" max="5" value="2">
                    </div>
                    <div id="retrievalOutput" class="grid-chunks"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="buildPrompt()">Next: Construct Prompt &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- STEP 6: PROMPT -->
            <section id="step6" class="step-section">
                <div class="card">
                    <div class="card-header"><div class="card-title"><div class="step-num">6</div> Prompt Engineering</div></div>
                    <div id="promptOutput" class="terminal"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" onclick="runLLM(this)">Next: Generate Answer &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- STEP 7: GENERATION -->
            <section id="step7" class="step-section">
                <div class="card">
                    <div class="card-header"><div class="card-title"><div class="step-num">7</div> AI Response</div></div>
                    <div id="llmOutput" class="ai-response hidden"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn" style="background:#475569" onclick="location.reload()">Reset</button>
                    </div>
                </div>
            </section>

        </div>
    </div>

<script>
    /* --- LOGIC ENGINE V6 --- */
    const state = { chunks: [], embeddings: [], searchResults: [] };
    const get = (id) => document.getElementById(id);
    const delay = (ms) => new Promise(r => setTimeout(r, ms));

    // Navigation Helper
    function scrollToStep(id) {
        // Update Sidebar
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const nav = get('nav-' + id);
        if(nav) nav.classList.add('active');
        
        // Update Main View
        const el = get(id);
        el.classList.add('active');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // 1. Chunking
    function runChunking() {
        const text = get('sourceText').value.trim();
        state.chunks = [];
        const size = 100;
        for(let i=0; i<text.length; i+=size) state.chunks.push(text.slice(i, i+size));
        
        const out = get('chunksOutput');
        out.innerHTML = '';
        state.chunks.forEach((c, i) => {
            out.innerHTML += `<div class="chunk-card"><strong>Chunk ${i+1}</strong>${c}</div>`;
        });
        scrollToStep('step2');
    }

    // 2. Embeddings
    async function runEmbeddings(btn) {
        btn.innerHTML = `<div class="loader"></div> Processing`;
        await delay(600);
        state.embeddings = state.chunks.map((t, i) => ({
            id: i, text: t, vector: Array.from({length: 4}, () => Math.random().toFixed(4))
        }));

        const out = get('vectorsOutput');
        out.innerHTML = '';
        state.embeddings.forEach(item => {
            out.innerHTML += `<div class="chunk-card"><strong>ID: ${item.id}</strong><div style="font-family:monospace; background:#f1f5f9;">[${item.vector.join(', ')}]</div></div>`;
        });

        btn.innerHTML = "Done";
        scrollToStep('step3');
    }

    // 3. Save -> JUMP TO INPUT
    async function saveVectors(btn) {
        btn.innerHTML = `<div class="loader"></div> Indexing`;
        await delay(400);
        btn.innerHTML = "Saved";
        btn.disabled = true;
        
        // ACTIVATE STEP 4
        scrollToStep('step4');
        
        // AUTO FOCUS THE INPUT (The Fix!)
        setTimeout(() => {
            const input = get('userQuery');
            input.focus();
            input.select();
        }, 500);
    }

    // 4. Retrieval (Triggered by Search Button)
    async function runRetrieval(btn) {
        const query = get('userQuery').value; // Removed .toLowerCase() here to keep original text for display
        
        if(!query) {
            alert("Please type a question!");
            get('userQuery').focus();
            return;
        }

        btn.innerHTML = `<div class="loader"></div> Searching`;
        await delay(800);

        // Scoring Logic
        const qLower = query.toLowerCase();
        state.searchResults = state.embeddings.map(doc => {
            let score = 0.1;
            qLower.split(' ').forEach(w => {
                if(w.length > 3 && doc.text.toLowerCase().includes(w)) score += 0.3;
            });
            return { ...doc, score: Math.min(score + Math.random()*0.1, 0.99) };
        }).sort((a,b) => b.score - a.score);

        const out = get('retrievalOutput');
        out.innerHTML = '';
        const k = parseInt(get('topK').value);
        state.searchResults.slice(0, k).forEach(item => {
            const pct = (item.score*100).toFixed(0);
            out.innerHTML += `<div class="chunk-card" style="border-color:var(--success)">
                <div style="display:flex; justify-content:space-between"><strong>Chunk ${item.id+1}</strong><span style="color:var(--success)">${pct}%</span></div>
                <div>${item.text}</div>
            </div>`;
        });

        btn.innerHTML = "Search Complete";
        scrollToStep('step5');
    }

    // 5. Prompt
    function buildPrompt() {
        const k = parseInt(get('topK').value);
        const ctx = state.searchResults.slice(0, k).map(c => c.text).join('\n---\n');
        get('promptOutput').innerText = `SYSTEM: Answer using context.\n\nCONTEXT:\n${ctx}\n\nUSER QUERY:\n${get('userQuery').value}`;
        scrollToStep('step6');
    }

    // 6. Generate
    async function runLLM(btn) {
        btn.innerHTML = `<div class="loader"></div> Generating`;
        await delay(1500);

        const query = get('userQuery').value.toLowerCase();
        let ans = "Based on the provided context, RAG retrieves specific data chunks to answer your query accurately.";
        
        // Logic for custom answers
        if(query.includes("who created")) ans = "This tool was created by a developer to demonstrate RAG.";
        if(query.includes("hallucination")) ans = "RAG reduces hallucinations by grounding the LLM with retrieved facts.";

        const out = get('llmOutput');
        out.classList.remove('hidden');
        out.innerText = ""; 
        
        let i = 0;
        function type() {
            if(i < ans.length) {
                out.innerText += ans.charAt(i);
                i++;
                setTimeout(type, 20);
            }
        }
        type();

        btn.innerHTML = "Regenerate";
        scrollToStep('step7');
    }

</script>
</body>
</html>
